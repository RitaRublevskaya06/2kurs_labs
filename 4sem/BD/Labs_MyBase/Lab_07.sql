USE Lab_03;

-- 1. Группировка с ROLLUP: Средняя стоимость сделок по товарам и покупателям
SELECT 
    t.Наименование AS Товар,
    p.ФИО AS Покупатель,
	CAST(AVG(t.Цена * s.Количество) AS DECIMAL(10,2)) AS Средняя_стоимость_сделки
FROM 
    Сделки s
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
GROUP BY 
    ROLLUP(t.Наименование, p.ФИО)
ORDER BY 
    t.Наименование, p.ФИО;


-- 2. Группировка с CUBE: Общая сумма сделок по товарам и покупателям
SELECT 
    t.Наименование AS Товар,
    p.ФИО AS Покупатель,
    SUM(t.Цена * s.Количество) AS Общая_сумма_сделок
FROM 
    Сделки s
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
GROUP BY 
    CUBE(t.Наименование, p.ФИО)
ORDER BY 
    t.Наименование, p.ФИО;


-- 3. Объединение результатов: сделки по Минску и Москве
SELECT 
    'Минск' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Минск%'
GROUP BY 
    t.Наименование

UNION

SELECT 
    'Москва' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Москва%'
GROUP BY 
    t.Наименование;

-- C UNION ALL
	SELECT 
    'Минск' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Минск%'
GROUP BY 
    t.Наименование

UNION ALL

SELECT 
    'Москва' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Москва%'
GROUP BY 
    t.Наименование;


-- 4. Пересечение товаров, купленных в Минске и Москве (INTERSECT)
SELECT 
    Товар
FROM (
    SELECT 
        t.Наименование AS Товар
    FROM 
        Сделки s
        JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
        JOIN Товары t ON s.ID_Товара = t.ID_Товара
    WHERE 
        p.Адрес LIKE '%Минск%'
    GROUP BY 
        t.Наименование
) минск

INTERSECT

SELECT 
    Товар
FROM (
    SELECT 
        t.Наименование AS Товар
    FROM 
        Сделки s
        JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
        JOIN Товары t ON s.ID_Товара = t.ID_Товара
    WHERE 
        p.Адрес LIKE '%Москва%'
    GROUP BY 
        t.Наименование
) москва;


-- 5. Разность товаров: куплены в Минске, но не в Москве (EXCEPT)
SELECT 
    'Минск' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Минск%'
GROUP BY 
    t.Наименование

EXCEPT

SELECT 
    'Москва' AS Город,
    t.Наименование AS Товар,
    SUM(s.Количество) AS Количество_продано
FROM 
    Сделки s
    JOIN Покупатели p ON s.ID_Покупателя = p.ID_Покупателя
    JOIN Товары t ON s.ID_Товара = t.ID_Товара
WHERE 
    p.Адрес LIKE '%Москва%'
GROUP BY 
    t.Наименование;


